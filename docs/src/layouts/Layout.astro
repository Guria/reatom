---
// import '@primer/css/dist/primer.css'
import Sidebar from '../components/Sidebar.astro'
import CurrentLinkHighlight from '../components/CurrentLinkHighlight.astro'
import HeadingCopyButton from '../components/HeadingCopyButton.astro'
// import Glitch from '../components/Glitch.astro'

const {
  frontmatter: { title = '404', description, file } = {} as Record<
    string,
    string
  >,
} = Astro.props

let source = 'https://github.com/artalar/reatom'
if (file) {
  if (file.startsWith('core')) {
    source = 'https://github.com/artalar/reatom/blob/v3/packages/core/README.md'
  } else if (file.startsWith('index')) {
    source = 'https://github.com/artalar/reatom/blob/v3/README.md'
  } else if (file.includes('packages')) {
    const name = file.match(/packages\/(.*)\.md/)?.[1]
    source = `https://github.com/artalar/reatom/tree/v3/packages/${name}/README.md`
  }
}
---

<!DOCTYPE html>
<html
  lang="en"
  data-color-mode="dark"
  data-light-theme="light"
  data-dark-theme="dark_dimmed"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    {description ? <meta name="description" content={description} /> : null}
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <link
      href="https://unpkg.com/@primer/css@^20.2.4/dist/primer.css"
      rel="stylesheet"
    />

    <style>
      main {
        width: calc(100vw - 20rem);
        max-width: 70rem;
        margin: auto;
        overflow-y: auto;
        height: 100vh;
      }

      @media (orientation: portrait) {
        main {
          min-width: calc(100% - 10rem);
        }
      }
    </style>
  </head>

  <body style="display: flex;">
    <Sidebar source={source} />
    <main class="markdown-body">
      <h1>{title}</h1>
      <slot />
      <footer class="d-flex flex-justify-center border-top p-3">
        <a href="https://github.com/artalar/reatom" target="_blank">github</a>
      </footer>
    </main>
    <script>
      document.querySelector('main')?.scrollIntoView()
    </script>
    <CurrentLinkHighlight />
    <HeadingCopyButton />
    <!-- <Glitch /> -->
    <script client>
      if (import.meta.env.PROD) {
        requestAnimationFrame(async () => {
          await navigator.serviceWorker
            ?.register('/sw.js')
            .then((registration) => registration.update())
            .catch(() => null)

          // console.log('client ready')

          const broadcast = new BroadcastChannel('sw')
          broadcast.postMessage({ type: 'client-ready' })
          broadcast.onmessage = ({ data, source }) => {
            // console.log('client message')
            if (
              data?.type === 'hot-update' &&
              location.pathname === new URL(data.url).pathname
            ) {
              source?.postMessage({ type: 'hot-update-received' })

              const doc = new DOMParser().parseFromString(
                data.text,
                'text/html',
              )
              const newMain = doc.querySelector('main')
              const main = document.querySelector('main')

              if (!newMain || newMain.innerHTML === main.innerHTML) {
                // console.log('cliens mains is equal')
                return
              }

              // console.log('cliens mains is not equal')

              // TODO show toast?
              main.replaceWith(newMain)
              setTimeout(() => window.ADD_COPY_BUTTONS?.())
            }
          }
        })
      }
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
  </body>
</html>
